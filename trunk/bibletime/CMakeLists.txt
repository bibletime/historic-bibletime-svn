PROJECT(bibletime CXX C)
CMAKE_MINIMUM_REQUIRED(VERSION 2.4.0)

#Version
SET(BT_VERSION "1.7.alpha")
#Specify which languages are to be installed for UI messages
SET(INSTALL_LOCALE_LANGS "de")

######################################################
# Find required packages
#
FIND_PACKAGE(Qt4 REQUIRED)
SET(QT_DBUSXML2CPP_EXECUTABLE "/usr/bin/qdbusxml2cpp") #TEMP HACK
FIND_PACKAGE(KDE4 REQUIRED)
FIND_PACKAGE(Gettext REQUIRED)
#
#custom includes
#
SET(CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake")
FIND_PACKAGE(CLucene REQUIRED)
FIND_PACKAGE(Sword REQUIRED)
######################################################


######################################################
# Define $bibletime_SOURCES
#
INCLUDE("${CMAKE_CURRENT_SOURCE_DIR}/cmake/bibletime_source_list.cmake")
######################################################


######################################################
# Generate config.h
SET(CONFIG_H_NEW_CONTENT "
//This file is autogenerated by CMake, do not edit.
\#define BT_VERSION \"${BT_VERSION}\"
")
#
IF(EXISTS "${CMAKE_CURRENT_BINARY_DIR}/config.h")
	FILE(READ ${CMAKE_CURRENT_BINARY_DIR}/config.h CONFIG_H_CONTENT)
ENDIF(EXISTS "${CMAKE_CURRENT_BINARY_DIR}/config.h")
#
IF ("${CONFIG_H_NEW_CONTENT}" STREQUAL "${CONFIG_H_CONTENT}")
	MESSAGE(STATUS "config.h is already up to date.")
ELSE ("${CONFIG_H_NEW_CONTENT}" STREQUAL "${CONFIG_H_CONTENT}")
	MESSAGE(STATUS "writing new config.h.")
	FILE(WRITE "${CMAKE_CURRENT_BINARY_DIR}/config.h" "${CONFIG_H_NEW_CONTENT}")
ENDIF ("${CONFIG_H_NEW_CONTENT}" STREQUAL "${CONFIG_H_CONTENT}")
######################################################


######################################################
# The actual build options
#
INCLUDE_DIRECTORIES(
	${QT_INCLUDE_DIR}	${QT_QTCORE_INCLUDE_DIR} ${QT_QTGUI_INCLUDE_DIR} ${QT_QTXML_INCLUDE_DIR} 
	${KDE4_INCLUDE_DIR}
	${CLUCENE_INCLUDE_DIR}			#CLucene headers
	${CLUCENE_LIBRARY_DIR}			#CLucene/clucene-config.h
	${SWORD_INCLUDE_DIR}
	${CMAKE_CURRENT_BINARY_DIR}		#for .h files generated from .ui
	${CMAKE_CURRENT_SOURCE_DIR}/src	# so that include paths like "frontend/..." work
)
#
#This must come before the target definition!
LINK_DIRECTORIES(
	${KDE4_LIB_DIR}
	${QT_LIBRARY_DIR}
	${CLUCENE_LIBRARY_DIR}
)
#
KDE4_ADD_EXECUTABLE(bibletime ${bibletime_SOURCES})
#
IF(MODE STREQUAL "RELEASE")
	MESSAGE(STATUS "Building in release mode")
	IF (NOT CMAKE_INSTALL_PREFIX)
		SET(CMAKE_INSTALL_PREFIX /usr/local/)
	ENDIF (NOT CMAKE_INSTALL_PREFIX)
	SET_TARGET_PROPERTIES(bibletime
		PROPERTIES 
			COMPILE_FLAGS "-w -fexceptions -O2"
	)
ELSE(MODE STREQUAL "RELEASE")
	MESSAGE(STATUS "Building in debug mode")
	SET(CMAKE_INSTALL_PREFIX install) #install to ./build/install
	SET_TARGET_PROPERTIES(bibletime
		PROPERTIES 
			COMPILE_FLAGS "-w -fexceptions -O0 -g" #Enable exception handling, debug code and no optimization
	)
ENDIF(MODE STREQUAL "RELEASE")
#
TARGET_LINK_LIBRARIES(bibletime
	${KDE4_KDEUI_LIBS}
	${KDE4_KDECORE_LIBS}
	${KDE4_KHTML_LIBS}
	QtCore
	QtGui
	QtXml
	${CLUCENE_LIBRARY}
	${SWORD_LIBRARY}
)
######################################################


######################################################
# Install files
#
# main binary
INSTALL(TARGETS "bibletime" DESTINATION "bin/")
# locales
FOREACH(_INSTALL_LOCALE_LANG ${INSTALL_LOCALE_LANGS})
	GETTEXT_PROCESS_PO_FILES(${_INSTALL_LOCALE_LANG} ALL "${CMAKE_CURRENT_SOURCE_DIR}/i18n/messages/${INSTALL_LOCALE_LANGS}.po")
	INSTALL(FILES "${CMAKE_CURRENT_BINARY_DIR}/${INSTALL_LOCALE_LANGS}.gmo" 
		DESTINATION "share/bibletime/locale/${INSTALL_LOCALE_LANGS}/LC_MESSAGES"
		RENAME "bibletime.mo")
ENDFOREACH(_INSTALL_LOCALE_LANG)
# icons
FILE(GLOB BT_INSTALL_ICONS_LIST ${CMAKE_CURRENT_SOURCE_DIR}/pics/icons/*.svg)
INSTALL(FILES ${BT_INSTALL_ICONS_LIST} DESTINATION "share/bibletime/icons/")
# display templates
FILE(GLOB BT_INSTALL_DISPLAY_TEMPLATES_LIST ${CMAKE_CURRENT_SOURCE_DIR}/src/display-templates/*.tmpl)
INSTALL(FILES ${BT_INSTALL_DISPLAY_TEMPLATES_LIST} DESTINATION "share/bibletime/display-templates/")
# splash screen
INSTALL(FILES "pics/startuplogo.png" DESTINATION "share/bibletime/pics/")
# xml menu and toolbar definition
INSTALL(FILES "src/xml/bibletimeui.rc" DESTINATION "share/bibletime/xml/")
######################################################


######################################################
# "make uninstall" target; see http://www.cmake.org/Wiki/CMake_FAQ#Can_I_do_.22make_uninstall.22_with_CMake.3F
#
CONFIGURE_FILE(
  "${CMAKE_CURRENT_SOURCE_DIR}/cmake/cmake_uninstall.cmake.in"
  "${CMAKE_CURRENT_BINARY_DIR}/cmake_uninstall.cmake"
  IMMEDIATE @ONLY
 )
ADD_CUSTOM_TARGET(uninstall "${CMAKE_COMMAND}" -P "${CMAKE_CURRENT_BINARY_DIR}/cmake_uninstall.cmake")
######################################################
